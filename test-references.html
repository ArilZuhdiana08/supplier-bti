<!DOCTYPE html>
<html>
<head>
    <title>Update Database Supplier References</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .supplier-reference-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .supplier-name { flex: 1; font-weight: bold; color: #333; }
        input[type="time"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button {
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status-msg { font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>Update Jadwal ke Database Supabase</h1>
    <p>Gunakan halaman ini untuk memastikan data benar-benar terkirim ke server (bukan cuma LocalStorage).</p>
    
    <div id="supplier-reference-list">
        </div>

    <script>
        const allSuppliers = [
          'PT. TENMA INDONESIA', 'PT. INOAC POLYTHECNO INDONESIA', 'PT. SIGMA INTI PRESISI',
          'PT. ATEJA KAWASHIMA', 'PT. YKK ZIPPER INDONESIA', 'PT. SEIREN INDONESIA',
          'PT. SINAR SUMINOE', 'PT. NISSHO INDUSTRI INDONESIA', 'PT. ENDOTA SINAR INDONESIA',
          'PT. PRIMARAYA GRAHA NUSANTARA', 'PT. TOYO QUALITY ONE', 'PT. ARMSTRONG INDONESIA',
          'PT. MEIWA', 'PT. RAJAWALI MITRA PRATAMA', 'PT. MEIHOKU', 'PT. SERVVO INDONESIA',
          'PT. INDAH VARIA EKA SELARAS', 'PT. BONECOM TRICOM (TEGAL)'
        ];

        function loadSupplierReferences() {
            const list = document.getElementById('supplier-reference-list');
            // Ambil data lokal hanya untuk tampilan awal
            let localRefs = JSON.parse(localStorage.getItem('supplierReferences') || '{}');
            
            list.innerHTML = allSuppliers.map(supplier => `
              <div class="supplier-reference-item">
                <div class="supplier-name">${supplier}</div>
                <input type="time" id="ref-${supplier.replace(/\s+/g, '-').toLowerCase()}" 
                       value="${localRefs[supplier] || ''}">
                <button onclick="saveToDatabase('${supplier}', this)">Simpan ke DB</button>
              </div>
            `).join('');
        }

        async function saveToDatabase(supplierName, btn) {
            const inputId = `ref-${supplierName.replace(/\s+/g, '-').toLowerCase()}`;
            const timeValue = document.getElementById(inputId).value;

            if (!timeValue) {
                alert('Pilih jam dulu!');
                return;
            }

            // Indikator Loading
            const originalText = btn.innerText;
            btn.innerText = 'Mengirim...';
            btn.disabled = true;

            try {
                // PROSES KIRIM KE SUPABASE VIA NETLIFY FUNCTION
                const response = await fetch('/.netlify/functions/save-supplier-reference', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        supplier_name: supplierName,
                        reference_time: timeValue
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Update LocalStorage juga sebagai cadangan
                    let localRefs = JSON.parse(localStorage.getItem('supplierReferences') || '{}');
                    localRefs[supplierName] = timeValue;
                    localStorage.setItem('supplierReferences', JSON.stringify(localRefs));
                    
                    alert('BERHASIL! Data masuk ke Supabase. Cek tabel di dashboard Supabase Anda.');
                } else {
                    throw new Error(result.error || 'Gagal menyimpan');
                }
            } catch (err) {
                console.error(err);
                alert('GAGAL: ' + err.message + '\nPastikan Netlify Function sudah dideploy.');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // Jalankan saat halaman dibuka
        loadSupplierReferences();
    </script>
</body>
</html>