<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/png" href="/assets/logo.png">
<title>Monitoring Kedatangan Supplier</title>

<!-- EXPORT LIB -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --primary: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
    --primary-solid: #8B0000;
    --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --card: #ffffff;
    --text: #1f2937;
    --muted: #6b7280;
    --border: #e5e7eb;
    --success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --success-solid: #4facfe;
    --warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --warning-solid: #fa709a;
    --danger: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    --danger-solid: #ff6b6b;
    --info: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    --info-solid: #a8edea;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
    background: var(--bg);
    color:var(--text);
    min-height: 100vh;
  }
  header{
    height:64px;
    padding:0 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    background: linear-gradient(135deg, #8B0000 0%, #DC143C 50%, #B22222 100%);
    color:#fff;
    box-shadow:0 4px 14px rgba(0,0,0,.15);
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
  }
  .header-content{
    display:flex;
    align-items:center;
    gap:12px;
  }
  .header-logo{
    width:70px;
    height:40px;
    border-radius:2px;
    background:#d9d9d9;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    flex-shrink:0;
  }
  .header-logo img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .header-title{
    font-size: 18px;
    font-weight: 600;
    margin:0;
  }
  .hamburger{
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.2);
    color: #fff;
    border-radius: 8px;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }
  .hamburger:hover{
    background: rgba(255,255,255,0.25);
    transform: scale(1.05);
  }

  /* Hamburger Menu */
  .hamburger-menu{
    position: fixed;
    top: 64px;
    left: 0;
    width: 300px;
    height: calc(100vh - 64px);
    background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
    box-shadow: 4px 0 25px rgba(0,0,0,0.15);
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 999;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    border-right: 1px solid rgba(0,0,0,0.05);
  }
  .hamburger-menu.open{
    transform: translateX(0);
  }
  .menu-header{
    padding: 24px 20px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
    color: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .menu-header h3{
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  .menu-items{
    flex: 1;
    padding: 16px 0;
  }
  .menu-item{
    display: block;
    padding: 16px 24px;
    color: #2d3748;
    text-decoration: none;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 15px;
    font-weight: 500;
    border-left: 3px solid transparent;
    position: relative;
  }
  .menu-item:hover{
    background: linear-gradient(90deg, rgba(139, 0, 0, 0.05) 0%, rgba(220, 20, 60, 0.08) 100%);
    color: #8B0000;
    border-left-color: #DC143C;
    padding-left: 28px;
  }
  .menu-item.active{
    background: linear-gradient(135deg, #8B0000 0%, #DC143C 100%);
    color: white;
    border-left-color: #fff;
    box-shadow: 0 2px 8px rgba(139, 0, 0, 0.2);
  }
  .menu-item.logout{
    margin-top: auto;
    border-top: 1px solid rgba(0,0,0,0.08);
    color: #e53e3e;
    font-weight: 600;
  }
  .menu-item.logout:hover{
    background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    color: white;
    border-left-color: #fff;
  }

  /* Overlay */
  .menu-overlay{
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 998;
  }
  .menu-overlay.open{
    opacity: 1;
    visibility: visible;
  }

  main{
    padding: 84px 20px 20px;
    max-width:1400px;
    margin:auto;
    transition: margin-left 0.3s ease;
  }

  /* Statistics Cards */
  .stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
    gap:20px;
    margin-bottom:30px;
  }
  .stat-card{
    background: var(--card);
    border-radius: 12px;
    padding:24px;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    border-left:4px solid var(--primary-solid);
    display:flex;
    align-items:center;
    gap:16px;
    transition: transform 0.3s ease;
  }
  .stat-card:hover{
    transform: translateY(-2px);
  }
  .stat-icon{
    width:48px;
    height:48px;
    border-radius: 12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    color:#fff;
    background: var(--primary);
  }
  .stat-content h3{
    margin:0;
    font-size:28px;
    font-weight:700;
    color:var(--text);
  }
  .stat-content p{
    margin:4px 0 0;
    color:var(--muted);
    font-size:14px;
  }

  /* Monthly Statistics */
  .monthly-stats{
    background: var(--card);
    border-radius: 12px;
    padding:24px;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
    margin-bottom:30px;
  }
  .monthly-stats h2{
    margin:0 0 20px;
    font-size:20px;
    color:var(--text);
  }
  .supplier-ranking{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:16px;
  }
  .ranking-item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:12px 16px;
    background: var(--info);
    border-radius: 8px;
    border:1px solid var(--border);
    transition: all 0.3s ease;
  }
  .ranking-item:hover{
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .ranking-item.top{
    background: var(--primary);
    color:#fff;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  .ranking-item .supplier-name{
    font-weight:600;
  }
  .ranking-item .count{
    font-weight:700;
    font-size:18px;
  }

  .filter-bar{
    background: var(--card);
    border-radius: 12px;
    padding:20px;
    display:flex;
    gap:15px;
    flex-wrap:wrap;
    align-items:center;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
    margin-bottom:20px;
    border:1px solid var(--border);
  }
  .filter-bar input,
  .filter-bar select{
    padding:12px 16px;
    border-radius: 8px;
    border:1px solid var(--border);
    min-width:150px;
    transition: all 0.3s ease;
  }
  .filter-bar input:focus,
  .filter-bar select:focus{
    outline: none;
    border-color: var(--primary-solid);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  .filter-bar button{
    padding:12px 20px;
    border-radius: 8px;
    border:none;
    font-weight:600;
    cursor:pointer;
    min-width:100px;
    transition: all 0.3s ease;
  }
  .btn-primary{
    background: var(--primary);
    color:#fff;
  }
  .btn-primary:hover{
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  .btn-secondary{
    background: var(--warning);
    color:#fff;
  }
  .btn-secondary:hover{
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);
  }
  .btn-disabled{
    opacity:.4;
    pointer-events:none;
    cursor: not-allowed;
  }
  .btn-danger{
    background: var(--danger);
    color:#fff;
  }
  .btn-danger:hover{
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
  }
  .card{
    background: var(--card);
    border-radius: 12px;
    box-shadow:0 12px 30px rgba(0,0,0,.08);
    overflow:hidden;
    border:1px solid var(--border);
  }
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0 10px;
    padding:12px;
  }
  thead th{
    font-size:12px;
    color:var(--muted);
    text-transform:uppercase;
    padding:6px 10px;
    text-align:left;
  }
  tbody tr{
    background:#f9fafb;
    border-radius: 8px;
    transition: all 0.3s ease;
  }
  tbody tr:hover{
    background: var(--info);
    transform: scale(1.01);
  }
  tbody td{
    padding:14px 12px;
    font-size:14px;
  }

  /* Status Badges */
  .status-badge{
    display:inline-block;
    padding:6px 12px;
    border-radius: 20px;
    font-size:11px;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing: 0.5px;
  }
  .status-advance{
    background: var(--success);
    color: #fff;
  }
  .status-tepat waktu{
    background: var(--primary);
    color: #fff;
  }
  .status-delay{
    background: var(--danger);
    color: #fff;
  }

  /* Sections */
  .section{
    display: none;
  }
  .section.active{
    display: block;
  }

  /* Supplier Reference */
  .supplier-reference-item{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    background: var(--info);
    border-radius: 8px;
    border: 1px solid var(--border);
  }
  .supplier-reference-item .supplier-name{
    font-weight: 600;
    font-size: 16px;
  }
  .supplier-reference-item input[type="time"]{
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    font-size: 14px;
  }
  .supplier-reference-item button{
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    background: var(--primary);
    color: white;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  .supplier-reference-item button:hover{
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  /* Loading Indicator */
  .loading-overlay{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }
  .loading-overlay.show{
    opacity: 1;
    visibility: visible;
  }
  .loading-content{
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
  }
  .loading-spinner{
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-solid);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  .loading-text{
    color: var(--text);
    font-size: 16px;
    font-weight: 500;
  }

  /* Mobile Responsiveness */
  @media (max-width: 768px) {
    main {
      padding: 84px 10px 20px;
    }

    .filter-bar {
      padding: 15px;
      gap: 10px;
    }

    .filter-bar input,
    .filter-bar select,
    .filter-bar button {
      min-width: 120px;
      font-size: 14px;
    }

    .card {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      min-width: 700px;
      font-size: 12px;
    }

    thead th {
      padding: 8px 6px;
      font-size: 11px;
    }

    tbody td {
      padding: 10px 6px;
      font-size: 12px;
      white-space: nowrap;
    }

    .status-badge {
      font-size: 10px;
      padding: 4px 8px;
    }

    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .stat-card {
      padding: 16px;
    }

    .stat-content h3 {
      font-size: 24px;
    }

    .monthly-stats {
      padding: 16px;
    }

    .supplier-ranking {
      grid-template-columns: 1fr;
    }

    .ranking-item {
      padding: 10px 12px;
      font-size: 14px;
    }

    .supplier-reference-item {
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      padding: 15px;
    }

    .supplier-reference-item .supplier-name {
      text-align: center;
      font-size: 14px;
    }

    .supplier-reference-item input[type="time"] {
      width: 100%;
      text-align: center;
    }

    .supplier-reference-item button {
      width: 100%;
      padding: 10px;
    }
  }

</style>
</head>

<body>

<header>
  <div class="header-content">
    <div class="header-logo">
      <img src="assets/logo.png" alt="Logo">
    </div>
    <h1 class="header-title">Dashboard Monitoring</h1>
  </div>
  <button class="hamburger" id="hamburger">‚ò∞</button>
</header>

<!-- Hamburger Menu -->
<div class="hamburger-menu" id="hamburger-menu">
  <div class="menu-header">
    <h3>Menu</h3>
  </div>
  <div class="menu-items">
    <button class="menu-item active" data-section="statistics">
      Monitoring Statistik
    </button>
    <button class="menu-item" data-section="filter">
      Filter Kedatangan Supplier
    </button>
    <button class="menu-item" data-section="reference">
      Waktu Referensi Supplier
    </button>
    <button class="menu-item logout" id="logout">
      Logout
    </button>
  </div>
</div>

<!-- Menu Overlay -->
<div class="menu-overlay" id="menu-overlay"></div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text">Membuat PDF...</div>
  </div>
</div>

<main>
  <!-- Statistics Section -->
  <div id="statistics-section" class="section active">
    <h1 style="margin-bottom: 30px; color: var(--text);">Dashboard Monitoring Supplier</h1>

    <!-- STATISTICS CARDS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-content">
          <h3 id="total-checkins">0</h3>
          <p>Total Check-in Bulan Ini</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üöõ</div>
        <div class="stat-content">
          <h3 id="unique-suppliers">0</h3>
          <p>Supplier Unik Bulan Ini</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üìà</div>
        <div class="stat-content">
          <h3 id="avg-daily">0</h3>
          <p>Rata-rata Check-in Harian</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-content">
          <h3 id="top-supplier-count">0</h3>
          <p>Check-in Tepat Waktu Terbanyak</p>
        </div>
      </div>
    </div>

    <!-- MONTHLY SUPPLIER STATISTICS -->
    <div class="monthly-stats">
      <h2>üìä Statistik Kedatangan Supplier Bulan Ini</h2>
      <div id="supplier-ranking" class="supplier-ranking">
        <!-- Supplier ranking will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Filter Section -->
  <div id="filter-section" class="section">
    <h1 style="margin-bottom: 30px; color: var(--text);">Filter & Export Kedatangan Supplier</h1>

    <!-- FILTER & EXPORT -->
    <div class="filter-bar">
      <input type="date" id="filter-date">

      <select id="filter-month">
        <option value="">Semua Bulan</option>
        <option value="0">Januari</option><option value="1">Februari</option>
        <option value="2">Maret</option><option value="3">April</option>
        <option value="4">Mei</option><option value="5">Juni</option>
        <option value="6">Juli</option><option value="7">Agustus</option>
        <option value="8">September</option><option value="9">Oktober</option>
        <option value="10">November</option><option value="11">Desember</option>
      </select>

      <select id="filter-year">
        <option value="">Semua Tahun</option>
      </select>

      <button id="reset-filter">Reset</button>

      <button id="export-excel" class="btn-primary btn-disabled">Export Excel</button>
      <button id="export-pdf" class="btn-secondary btn-disabled">Export PDF</button>
    </div>

    <!-- TABLE -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Supplier</th>
            <th>Kendaraan</th>
            <th>Status</th>
            <th>Lokasi</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Reference Time Section -->
  <div id="reference-section" class="section">
    <h1 style="margin-bottom: 30px; color: var(--text);">Pengaturan Waktu Referensi Supplier</h1>

    <div class="card" style="padding: 30px;">
      <h2 style="margin-bottom: 20px; color: var(--text);">Set Waktu Referensi per Supplier</h2>
      <p style="color: var(--muted); margin-bottom: 30px;">
        Atur waktu referensi untuk setiap supplier. Sistem akan menghitung status kedatangan berdasarkan waktu referensi dengan toleransi ¬±10 menit.
      </p>

      <div id="supplier-reference-list" style="display: grid; gap: 15px;">
        <!-- Supplier reference settings will be populated by JavaScript -->
      </div>
    </div>
  </div>
</main>

<script>
  // ================================
  // GLOBAL STATE
  // ================================
  const rawData = [];
  let filteredData = [];

  // ================================
  // DOM ELEMENTS
  // ================================
  const tbody = document.getElementById('tbody');
  const filterDate = document.getElementById('filter-date');
  const filterMonth = document.getElementById('filter-month');
  const filterYear = document.getElementById('filter-year');
  const resetBtn = document.getElementById('reset-filter');
  const exportExcelBtn = document.getElementById('export-excel');
  const exportPdfBtn = document.getElementById('export-pdf');

  const totalCheckinsEl = document.getElementById('total-checkins');
  const uniqueSuppliersEl = document.getElementById('unique-suppliers');
  const avgDailyEl = document.getElementById('avg-daily');
  const topSupplierCountEl = document.getElementById('top-supplier-count');
  const supplierRankingEl = document.getElementById('supplier-ranking');

  const hamburger = document.getElementById('hamburger');
  const hamburgerMenu = document.getElementById('hamburger-menu');
  const menuOverlay = document.getElementById('menu-overlay');
  const menuItems = document.querySelectorAll('.menu-item');
  const sections = document.querySelectorAll('.section');
  const supplierReferenceList = document.getElementById('supplier-reference-list');

  let currentSection = 'statistics';
  let supplierReferences = {};

  // ================================
  // MENU
  // ================================
  hamburger.onclick = () => {
    hamburgerMenu.classList.toggle('open');
    menuOverlay.classList.toggle('open');
  };

  menuOverlay.onclick = () => {
    hamburgerMenu.classList.remove('open');
    menuOverlay.classList.remove('open');
  };

  menuItems.forEach(item => {
    item.onclick = () => {
      if (item.id === 'logout') {
        sessionStorage.removeItem('adminLoggedIn');
        location.href = 'index.html';
        return;
      }

      const section = item.dataset.section;
      sections.forEach(s => s.classList.remove('active'));
      document.getElementById(section + '-section').classList.add('active');

      menuItems.forEach(m => m.classList.remove('active'));
      item.classList.add('active');

      hamburgerMenu.classList.remove('open');
      menuOverlay.classList.remove('open');

      if (section === 'filter') {
        renderTable(filteredData);
      }

      if (section === 'reference') {
        loadSupplierReferences();
      }
    };
  });

  // ================================
  // RENDER TABLE
  // ================================
  function renderTable(data) {
    tbody.innerHTML = data.length
      ? data.map(d => `
        <tr>
          <td>${new Date(d.timestamp).toLocaleString()}</td>
          <td>${d.supplier_name}</td>
          <td>${d.vehicle_no || '-'}</td>
          <td>
            <span class="status-badge status-${(d.status || 'Tepat waktu').toLowerCase()}">
              ${d.status || 'Tepat waktu'}
            </span>
          </td>
            <td>${d.location?.lat && d.location?.lng
              ? `${d.location.lat},${d.location.lng}`
              : 'PT. Bonecom Tricom Plant KIMU'}
            </td>
          <td>
            <button onclick="deleteCheckin(${d.id})" class="btn-danger">Hapus</button>
          </td>
        </tr>
      `).join('')
      : `<tr><td colspan="6">Tidak ada data</td></tr>`;
  }

  // ================================
  // FILTER
  // ================================
  function applyFilter() {
    filteredData = rawData.filter(d => {
      const dt = new Date(d.timestamp);
      return (!filterDate.value || dt.toISOString().slice(0, 10) === filterDate.value)
        && (filterMonth.value === '' || dt.getMonth() == filterMonth.value)
        && (filterYear.value === '' || dt.getFullYear() == filterYear.value);
    });

    renderTable(filteredData);

    const active = filterDate.value || filterMonth.value !== '' || filterYear.value !== '';
    exportExcelBtn.classList.toggle('btn-disabled', !active);
    exportPdfBtn.classList.toggle('btn-disabled', !active);
  }

  filterDate.onchange = applyFilter;
  filterMonth.onchange = applyFilter;
  filterYear.onchange = applyFilter;

  resetBtn.onclick = () => {
    filterDate.value = '';
    filterMonth.value = '';
    filterYear.value = '';
    filteredData = [...rawData];
    renderTable(filteredData);
    exportExcelBtn.classList.add('btn-disabled');
    exportPdfBtn.classList.add('btn-disabled');
  };

  // ================================
  // LOAD CHECKINS (üî• FIX UTAMA)
  // ================================
  async function loadCheckins() {
    try {
      const res = await fetch('/.netlify/functions/checkins');
      const data = await res.json();

      rawData.length = 0;
      rawData.push(...data);

      // üî• FIX: sync filteredData
      filteredData = [...rawData];

      // üî• FIX: populate year AFTER data exists
      filterYear.innerHTML = '<option value="">Semua Tahun</option>';
      [...new Set(rawData.map(d => new Date(d.timestamp).getFullYear()))]
        .sort((a, b) => b - a)
        .forEach(y => {
          const o = document.createElement('option');
          o.value = y;
          o.textContent = y;
          filterYear.appendChild(o);
        });

      updateStatistics();
      renderTable(rawData);

    } catch (err) {
      console.error(err);
    }
  }

  // ================================
  // STATISTICS
  // ================================
  function updateStatistics() {
    totalCheckinsEl.textContent = rawData.length;
    uniqueSuppliersEl.textContent = new Set(rawData.map(d => d.supplier_name)).size;
    avgDailyEl.textContent = rawData.length ? Math.round(rawData.length / 30) : 0;

    const ranking = {};
    rawData.forEach(d => {
      if ((d.status || 'Tepat waktu') === 'Tepat waktu') {
        ranking[d.supplier_name] = (ranking[d.supplier_name] || 0) + 1;
      }
    });

    const sorted = Object.entries(ranking).sort((a, b) => b[1] - a[1]);
    topSupplierCountEl.textContent = sorted[0]?.[1] || 0;

    supplierRankingEl.innerHTML = sorted.length
      ? sorted.slice(0, 5).map(([s, c], i) => `
          <div class="ranking-item ${i === 0 ? 'top' : ''}">
            <div class="supplier-name">${i + 1}. ${s}</div>
            <div class="count">${c}</div>
          </div>
        `).join('')
      : '<div class="ranking-item">Belum ada data</div>';
  }
  // ================================
  // SUPPLIER REFERENCE
  // ================================
  const allSuppliers = [
    'PT. TENMA INDONESIA',
    'PT. INOAC POLYTHECNO INDONESIA',
    'PT. SIGMA INTI PRESISI',
    'PT. ATEJA KAWASHIMA',
    'PT. YKK ZIPPER INDONESIA',
    'PT. SEIREN INDONESIA',
    'PT. SINAR SUMINOE',
    'PT. NISSHO INDUSTRI INDONESIA',
    'PT. ENDOTA SINAR INDONESIA',
    'PT. PRIMARAYA GRAHA NUSANTARA',
    'PT. TOYO QUALITY ONE',
    'PT. ARMSTRONG INDONESIA',
    'PT. MEIWA',
    'PT. RAJAWALI MITRA PRATAMA',
    'PT. MEIHOKU',
    'PT. SERVVO INDONESIA',
    'PT. INDAH VARIA EKA SELARAS',
    'PT. BONECOM TRICOM (TEGAL)'
  ];

  function loadSupplierReferences() {
    supplierReferences = JSON.parse(
      localStorage.getItem('supplierReferences') || '{}'
    );

    supplierReferenceList.innerHTML = allSuppliers.map(supplier => {
      const id = `ref-${supplier.replace(/\s+/g, '-').toLowerCase()}`;
      return `
        <div class="supplier-reference-item">
          <div class="supplier-name">${supplier}</div>
          <input type="time" id="${id}" value="${supplierReferences[supplier] || ''}">
          <button onclick="saveSupplierReference('${supplier}')">Simpan</button>
        </div>
      `;
    }).join('');
  }

  function saveSupplierReference(supplierName) {
    const inputId = `ref-${supplierName.replace(/\s+/g, '-').toLowerCase()}`;
    const timeValue = document.getElementById(inputId).value;

    if (!timeValue) {
      alert('Silakan pilih waktu terlebih dahulu');
      return;
    }

    supplierReferences[supplierName] = timeValue;
    localStorage.setItem(
      'supplierReferences',
      JSON.stringify(supplierReferences)
    );

    alert(`Waktu referensi ${supplierName} disimpan (${timeValue})`);
  }

  // expose
  window.saveSupplierReference = saveSupplierReference;
  // ================================
  // EXPORT FUNCTIONS
  // ================================
  function exportToExcel(data) {
    if (!data.length) {
      alert('Tidak ada data untuk diekspor');
      return;
    }

    const ws = XLSX.utils.json_to_sheet(data.map(d => ({
      Waktu: new Date(d.timestamp).toLocaleString(),
      Supplier: d.supplier_name,
      Kendaraan: d.vehicle_no || '-',
      Status: d.status || 'Tepat waktu',
      Lokasi: d.location?.lat && d.location?.lng
        ? `${d.location.lat},${d.location.lng}`
        : 'PT. Bonecom Tricom Plant KIMU'
    })));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Checkins');
    XLSX.writeFile(wb, 'checkins.xlsx');
  }

  function exportToPDF(data) {
    if (!data.length) {
      alert('Tidak ada data untuk diekspor');
      return;
    }

    // Show loading indicator
    const loadingOverlay = document.getElementById('loading-overlay');
    loadingOverlay.classList.add('show');

    // Use setTimeout to make PDF generation non-blocking
    setTimeout(() => {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const tableData = data.map(d => [
          new Date(d.timestamp).toLocaleString(),
          d.supplier_name,
          d.vehicle_no || '-',
          d.status || 'Tepat waktu',
          d.location?.lat && d.location?.lng
            ? `${d.location.lat},${d.location.lng}`
            : 'PT. Bonecom Tricom Plant KIMU'
        ]);

        // Create simple text-based PDF (more reliable than autoTable plugin)
        doc.setFontSize(16);
        doc.text('Data Check-in Supplier', 20, 20);

        doc.setFontSize(12);
        let y = 40;

        // Add header
        doc.text('No. | Waktu | Supplier | Kendaraan | Status | Lokasi', 20, y);
        y += 10;
        doc.line(20, y, 190, y); // horizontal line
        y += 5;

        // Add data rows
        tableData.forEach((row, index) => {
          if (y > 270) { // New page if needed
            doc.addPage();
            y = 20;
            doc.text('No. | Waktu | Supplier | Kendaraan | Status | Lokasi', 20, y);
            y += 10;
            doc.line(20, y, 190, y);
            y += 5;
          }

          const rowText = `${index + 1}. ${row.join(' | ')}`;
          doc.text(rowText, 20, y);
          y += 8;
        });

        // Generate PDF as blob and download
        const pdfBlob = doc.output('blob');
        const url = URL.createObjectURL(pdfBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'checkins.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Hide loading indicator
        loadingOverlay.classList.remove('show');
      } catch (error) {
        // Hide loading indicator
        loadingOverlay.classList.remove('show');
        alert('Gagal membuat PDF: ' + error.message);
      }
    }, 100);
  }

  // Attach event listeners to export buttons
  exportExcelBtn.onclick = () => exportToExcel(filteredData);
  exportPdfBtn.onclick = () => exportToPDF(filteredData);

  // ================================
  // INIT
  // ================================
  loadCheckins();
</script>
<script src="/js/arrival-filter.js"></script>
</body>
</html>
