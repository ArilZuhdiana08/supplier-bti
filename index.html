<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Absensi Supplier - Check-in</title>
  <style>
    :root{--accent:#0b6efd;--card:#ffffffcc;--text:#222;--text-light:#666;--border:#e0e0e0}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;color:var(--text)}
    body{
      background: url('assets/background.jpg') center/cover no-repeat fixed;
      background-color:#f0f2f5;
      display:flex;align-items:center;justify-content:center;padding:16px;min-height:100vh;position:relative;overflow-x:hidden;
      filter:brightness(0.95) contrast(0.98);
    }
    body::after{
      content:'';
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.4);
      backdrop-filter:blur(2px);
      z-index:1;
      pointer-events:none
    }
    
    /* Header */
    header{position:fixed;top:0;left:0;right:0;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;background:linear-gradient(90deg,rgba(255,255,255,0.85),rgba(255,255,255,0.8));backdrop-filter:blur(10px);box-shadow:0 2px 8px rgba(0,0,0,0.08);z-index:100}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .logo{width:40px;height:40px;border-radius:6px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;flex-shrink:0;overflow:hidden}
    .company-logo{width:32px;height:32px;border-radius:4px;background:#f5f5f5;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden}
    .company-logo img{width:100%;height:100%;object-fit:cover}
    .brand-text>*{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .company-title{font-size:14px;font-weight:700;line-height:1.2}
    .company-subtitle{font-size:11px;color:var(--text-light);line-height:1.2}

    /* Hamburger button - touch friendly */
    .hamburger{width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:6px;background:white;border:1px solid var(--border);cursor:pointer;font-size:20px;flex-shrink:0;transition:all .2s}
    .hamburger:active{background:#f5f5f5}

    /* Side menu */
    .sidemenu{position:fixed;top:60px;left:0;bottom:0;width:min(320px,85vw);background:#fff;box-shadow:2px 0 12px rgba(0,0,0,0.1);transform:translateX(-100%);transition:transform .3s ease;overflow-y:auto;padding:16px;z-index:99}
    .sidemenu.open{transform:translateX(0)}
    .sidemenu h3{margin:0 0 12px;font-size:16px}
    .sidemenu h4{margin:8px 0 8px;font-size:14px}
    .admin-controls{margin:12px 0}
    .supplier-list{margin-top:12px;border-top:1px solid var(--border);padding-top:12px}
    input[type=password]{width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);font-size:16px;margin-top:6px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    table th,table td{padding:8px;border-bottom:1px solid #f3f3f3;text-align:left}
    table th{background:#f9f9f9;font-weight:600}

    /* Main container */
    main{margin-top:60px;width:100%;display:flex;align-items:center;justify-content:center;min-height:calc(100vh - 60px);position:relative;z-index:10}

    /* Main card */
    .card{width:100%;max-width:100%;background:rgba(255,255,255,0.9);backdrop-filter:blur(12px);padding:24px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.15);display:grid;grid-template-columns:1fr;gap:20px;max-width:500px}
    .left{padding:0}
    .right{display:flex;align-items:center;justify-content:center}
    h1{margin:0 0 8px;font-size:18px;font-weight:700}
    p.lead{margin:0 0 16px;color:var(--text-light);font-size:14px;line-height:1.5}

    label{display:block;font-size:13px;margin-top:12px;color:var(--text);font-weight:500}
    input[type=text]{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);margin-top:6px;font-size:16px;appearance:none}
    input[type=text]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(11,110,253,0.1)}
    
    input[type=time]{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);margin-top:6px;font-size:16px;appearance:none}
    input[type=time]:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(11,110,253,0.1)}
    
    select{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);margin-top:6px;font-size:16px;appearance:none;background-image:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDEyIDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNiA2TDExIDEiIHN0cm9rZT0iIzY2NiIgc3Ryb2tlLXdpZWRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+');background-repeat:no-repeat;background-position:right 12px center;background-size:12px;padding-right:40px;}
    select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(11,110,253,0.1)}
    
    .btn{display:inline-block;padding:12px 16px;background:#8B2E2E;color:#fff;border-radius:8px;border:none;cursor:pointer;margin-top:12px;font-size:14px;font-weight:600;transition:all .2s;touch-action:manipulation;min-height:48px;display:flex;align-items:center;justify-content:center}
    .btn:active{transform:scale(0.98);opacity:0.9}
    .btn.secondary{background:#eee;color:var(--text)}

    .meta{font-size:13px;color:var(--text-light);margin-top:12px;line-height:1.5}
    .status{margin-top:12px;padding:12px;border-radius:8px;background:rgba(11,110,253,0.08);border-left:4px solid var(--accent);font-size:13px;display:none}
    .status.show{display:block}

    /* Helper text */
    .small{font-size:12px;color:var(--text-light);margin-top:8px;line-height:1.4}
    
    /* Overlay backdrop */
    .menu-backdrop{position:fixed;top:60px;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);opacity:0;pointer-events:none;transition:opacity .3s;z-index:98}
    .menu-backdrop.open{opacity:1;pointer-events:auto}

    /* Tablet layout */
    @media(min-width:600px){
      header{padding:0 24px;height:64px}
      .hamburger{width:50px;height:50px}
      .sidemenu{top:64px;width:320px}
      .menu-backdrop{top:64px}
      main{margin-top:64px;min-height:calc(100vh - 64px)}
      .company-logo{width:40px;height:40px}
      
      .card{padding:32px;grid-template-columns:1fr;max-width:500px}
      h1{font-size:22px}
      p.lead{font-size:15px}
      label{font-size:14px;margin-top:14px}
      input[type=text]{padding:12px;font-size:16px}
      select{padding:12px;font-size:16px}
      .btn{padding:12px 20px;font-size:15px;min-height:50px}
    }

    /* Desktop layout */
    @media(min-width:900px){
      body{padding:32px}
      .card{max-width:500px}
    }

    /* Large desktop */
    @media(min-width:1200px){
      .card{padding:40px}
      h1{font-size:24px}
      p.lead{font-size:16px}
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <div class="logo">
        <img src="assets/logo.png" alt="Company Logo" style="width:100%;height:100%;object-fit:contain;padding:2px">
      </div>
      <div class="brand-text">
        <div class="company-title">PT. BONECOM TRICOM KIMU PLANT</div>
        <div class="company-subtitle">Gate Receiving</div>
      </div>
    </div>
    <button id="hamburger" class="hamburger" title="Menu" aria-label="Menu">‚ò∞</button>
  </header>

  <div id="menu-backdrop" class="menu-backdrop"></div>

  <nav id="sidemenu" class="sidemenu" aria-hidden="true">
    <h3>Admin Panel</h3>
    <div class="admin-controls">
      <div id="admin-area">
        <div style="margin-bottom:8px;font-size:13px">Masuk sebagai admin untuk melihat data supplier.</div>
        <!-- Password input with toggle -->
        <div style="position:relative;">
          <input id="admin-password" type="password" placeholder="Password admin" style="width:100%;padding-right:40px">
          <button id="toggle-password" type="button" style="
            position:absolute;
            right:8px;
            top:50%;
            transform:translateY(-50%);
            border:none;
            background:none;
            cursor:pointer;
            font-size:16px;
          ">üëÅÔ∏è</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="admin-login" class="btn" style="flex:1">Login</button>
          <button id="admin-logout" class="btn secondary" style="display:none;flex:1">Logout</button>
        </div>
      </div>

      <div class="supplier-list" id="supplier-list" style="display:none">
        <h4>Daftar Supplier</h4>
        <div id="supplier-table-wrap">Loading...</div>
      </div>
    </div>
  </nav>

  <main>
    <section class="card" role="main">
      <div class="left">
        <h1>Form Check-in Supplier</h1>
        <p class="lead">Masukkan nama supplier. Lokasi akan dicatat otomatis.</p>

        <label for="supplier-name">Nama Supplier *</label>
        <select id="supplier-name" required style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);margin-top:6px;font-size:16px;appearance:none;background-image:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDEyIDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0xIDFMNiA2TDExIDEiIHN0cm9rZT0iIzY2NiIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPC9zdmc+');background-repeat:no-repeat;background-position:right 12px center;background-size:12px;padding-right:40px;">
          <option value="">Pilih nama supplier...</option>
        </select>

        <label for="vehicle">No. Kendaraan (opsional)</label>
        <input id="vehicle" type="text" placeholder="Contoh: B 1234 ABC">

        <div class="meta">
          <div><strong>Lokasi:</strong> <span id="geo-loc">Mencari lokasi...</span></div>
          <div class="small">‚ö†Ô∏è Pastikan GPS aktif dan izin lokasi sudah diberikan.</div>
        </div>

        <button id="submit-checkin" class="btn">Submit Check-in</button>
        <div id="submit-result" class="status"></div>
      </div>
    </section>
  </main>

  <script>
    // ===== DOM Elements =====
    const sidemenu = document.getElementById('sidemenu');
    const menuBackdrop = document.getElementById('menu-backdrop');
    const hamburger = document.getElementById('hamburger');
    const adminLoginBtn = document.getElementById('admin-login');
    const adminLogoutBtn = document.getElementById('admin-logout');
    const adminPasswordInput = document.getElementById('admin-password');
    const togglePasswordBtn = document.getElementById('toggle-password');
    const supplierListEl = document.getElementById('supplier-list');
    const supplierTableWrap = document.getElementById('supplier-table-wrap');
    const submitBtn = document.getElementById('submit-checkin');
    const resultEl = document.getElementById('submit-result');
    const geoLocEl = document.getElementById('geo-loc');

    // ===== Menu Toggle =====
    function closeMenu(){
      sidemenu.classList.remove('open');
      menuBackdrop.classList.remove('open');
      sidemenu.setAttribute('aria-hidden', 'true');
    }

    hamburger.addEventListener('click', ()=> {
      const isOpen = sidemenu.classList.toggle('open');
      menuBackdrop.classList.toggle('open', isOpen);
      sidemenu.setAttribute('aria-hidden', String(!isOpen));
    });

    menuBackdrop.addEventListener('click', closeMenu);

    document.addEventListener('keydown', (e)=> {
      if(e.key === 'Escape') closeMenu();
    });

    // ===== Toggle password visibility =====
    togglePasswordBtn.addEventListener('click', ()=>{
      if(adminPasswordInput.type === 'password'){
        adminPasswordInput.type = 'text';
        togglePasswordBtn.textContent = 'üôà';
      } else {
        adminPasswordInput.type = 'password';
        togglePasswordBtn.textContent = 'üëÅÔ∏è';
      }
    });

    // ===== Admin Authentication =====
    adminLoginBtn.addEventListener('click', ()=>{
      const pwd = adminPasswordInput.value || '';
      if(pwd.trim() !== 'Bonecom'){
        alert('‚ùå Password admin salah');
        adminPasswordInput.focus();
        return;
      }

      sessionStorage.setItem('adminLoggedIn', 'true');
      window.location.href = 'admin-monitor.html';
    });

    adminLogoutBtn.addEventListener('click', ()=>{
      supplierListEl.style.display = 'none';
      supplierTableWrap.innerHTML = '';
      adminLogoutBtn.style.display = 'none';
      adminLoginBtn.style.display = 'inline-block';
      adminPasswordInput.style.display = 'block';
      adminPasswordInput.value = '';
    });

    adminPasswordInput.addEventListener('keypress', (e)=>{
      if(e.key === 'Enter') adminLoginBtn.click();
    });

    // ===== Geolocation =====
    let currentPos = null;
    function showPos(p){
      currentPos = p;
      const lat = p.coords.latitude.toFixed(6);
      const lng = p.coords.longitude.toFixed(6);
      const acc = Math.round(p.coords.accuracy);
      geoLocEl.textContent = `${lat}, ${lng} (¬±${acc}m)`;
      geoLocEl.style.color = acc > 50 ? '#d32f2f' : '#2e7d32';
    }
    function errPos(){
      geoLocEl.textContent = '‚ùå Lokasi tidak tersedia';
      geoLocEl.style.color = '#d32f2f';
    }

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(showPos, errPos, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      });
    } else {
      errPos();
    }

    // ===== Geofencing Configuration =====
    // Lokasi gate: 6¬∞16'54.0"S 107¬∞05'15.9"E (-6.281659, 107.087749)
    const GATE_LOCATION = {
      lat: -6.281659,
      lng: 107.087749,
      radius: 100 // radius 100 meter dari gate
    };

    // Fungsi untuk menghitung jarak antara dua koordinat (Haversine formula)
    function calculateDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3; // Earth's radius in meters
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lng2 - lng1) * Math.PI / 180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c; // Distance in meters
    }

    // ===== Load Suppliers =====
    // Daftar supplier yang tersedia (hardcoded)
    const suppliers = [
      { supplier_id: 1, supplier_name: 'PT. Mitra Supplier A' },
      { supplier_id: 2, supplier_name: 'PT. Cahaya Abadi' },
      { supplier_id: 3, supplier_name: 'CV. Logistik Nusantara' },
      { supplier_id: 4, supplier_name: 'PT. Transportasi Prima' },
      { supplier_id: 5, supplier_name: 'PT. Distribusi Makmur' }
    ];

    // Populate supplier select options
    const supplierSelect = document.getElementById('supplier-name');
    suppliers.forEach(supplier => {
      const option = document.createElement('option');
      option.value = supplier.supplier_name;
      option.textContent = supplier.supplier_name;
      supplierSelect.appendChild(option);
    });

    // ===== Form Submit =====
    submitBtn.addEventListener('click', ()=>{
      const name = document.getElementById('supplier-name').value.trim();
      const vehicle = document.getElementById('vehicle').value.trim();

      if(!name){
        alert('‚ö†Ô∏è Pilih nama supplier terlebih dahulu');
        document.getElementById('supplier-name').focus();
        return;
      }

      if(!currentPos){
        alert('‚ö†Ô∏è Lokasi GPS belum tersedia');
        return;
      }

      // Get reference time from admin panel settings
      const supplierReferences = JSON.parse(localStorage.getItem('supplierReferences') || '{}');
      const referenceTime = supplierReferences[name];

      if(!referenceTime){
        alert('‚ö†Ô∏è Waktu referensi untuk supplier ini belum diatur di panel admin.\n\nSilakan hubungi admin untuk mengatur waktu referensi terlebih dahulu.');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Memproses...';

      try {
        // ===== Geofencing Validation =====
        const distance = calculateDistance(
          currentPos.coords.latitude,
          currentPos.coords.longitude,
          GATE_LOCATION.lat,
          GATE_LOCATION.lng
        );

        if (distance > GATE_LOCATION.radius) {
          alert(`‚ùå Anda berada di luar area gate!\n\nJarak dari gate: ${Math.round(distance)} meter\nRadius yang diizinkan: ${GATE_LOCATION.radius} meter\n\nPastikan Anda berada di area 6¬∞16'54.0"S 107¬∞05'15.9"E.`);
          return;
        }

        // ===== Calculate Status =====
        const now = new Date();
        const [refHours, refMinutes] = referenceTime.split(':').map(Number);
        const referenceDateTime = new Date(now);
        referenceDateTime.setHours(refHours, refMinutes, 0, 0);

        const timeDiff = (now - referenceDateTime) / (1000 * 60); // difference in minutes
        let status = 'Tepat waktu';

        if (timeDiff < -10) {
          status = 'Advance'; // More than 10 minutes early
        } else if (timeDiff > 10) {
          status = 'Delay'; // More than 10 minutes late
        }

        // Find supplier by name (case insensitive)
        const supplier = suppliers.find(s => s.supplier_name.toLowerCase() === name.toLowerCase());
        if (!supplier) {
          // This shouldn't happen with select, but keep for safety
          console.log('Supplier tidak ditemukan:', name);
        }

        // Simpan data check-in ke localStorage
        const checkinData = {
          timestamp: new Date().toISOString(),
          supplier_name: supplier ? supplier.supplier_name : name,
          vehicle_no: vehicle || null,
          reference_time: referenceTime,
          status: status,
          location: {
            lat: currentPos.coords.latitude,
            lng: currentPos.coords.longitude
          }
        };

        // Ambil data check-in yang sudah ada dari localStorage
        const existingCheckins = JSON.parse(localStorage.getItem('checkins') || '[]');

        // Tambahkan data check-in baru
        existingCheckins.push(checkinData);

        // Simpan kembali ke localStorage
        localStorage.setItem('checkins', JSON.stringify(existingCheckins));

        // Tampilkan pesan sukses
        resultEl.classList.add('show');
        resultEl.textContent = `‚úÖ Check-in berhasil: ${supplier ? supplier.supplier_name : name} (${status})`;

        // Reset form
        document.getElementById('supplier-name').value = '';
        document.getElementById('vehicle').value = '';

        console.log('Check-in saved:', checkinData);

      } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Terjadi kesalahan saat check-in');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Check-in';
      }
    });

    document.getElementById('vehicle').addEventListener('keypress', (e)=>{
      if(e.key === 'Enter') submitBtn.click();
    });
  </script>
</body>
</html>
